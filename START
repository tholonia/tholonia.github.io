#!/bin/bash

# Startup script for chirpy2 Docker container

CONTAINER_NAME="chirpyRun"
IMAGE_NAME="chirpy2:updated"

echo "üîç Checking Docker environment..."

# Check if container exists
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "üì¶ Container '${CONTAINER_NAME}' exists."
    
    # Check if container is running
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "‚úÖ Container is already running."
        echo "üîó Attaching to container..."
        docker exec -it ${CONTAINER_NAME} /bin/bash
    else
        echo "‚ñ∂Ô∏è  Starting existing container..."
        docker start -ai ${CONTAINER_NAME}
    fi
else
    echo "üì¶ Container '${CONTAINER_NAME}' does not exist."
    
    # Check if image exists
    if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${IMAGE_NAME}$"; then
        echo "üî® Image '${IMAGE_NAME}' not found. Building..."
        docker build -t ${IMAGE_NAME} .
        
        if [ $? -ne 0 ]; then
            echo "‚ùå Failed to build image."
            exit 1
        fi
        echo "‚úÖ Image built successfully."
    else
        echo "‚úÖ Image '${IMAGE_NAME}' exists."
    fi
    
    echo "üöÄ Creating and running new container..."
    docker run -it -p 4321:4321 -p 35729:35729 \
        --mount src=$(pwd),target=$(pwd),type=bind \
        --workdir $(pwd) \
        --name ${CONTAINER_NAME} \
        ${IMAGE_NAME} /bin/bash
fi

